- name: Create GCP Instance and PostgreSQL Database
  hosts: group-postgres
  gather_facts: False
  tasks:

    - name: Install PostgreSQL
      become: yes
      apt:
        name: postgresql
        state: present

    - name: Create Database from SQL File
      become: yes
      postgresql_db:
        name: schedule
        login_host: "{{ DB_HOST }}"
        login_user: "{{ POSTGRES_USER }}"
        login_password: "{{ POSTGRES_PASSWORD }}"
        state: import
        target: "{{ PATH_TO_RESTORE_FILE }}"

    - name: Schedule SQL File to Run Every Minute
      become: yes
      cron:
        name: Run SQL File Every Minute
        minute: "*"
        job: "psql -h localhost -U postgres -d mydatabase < {{ PATH_TO_FIX_SQL_FILE }}"

